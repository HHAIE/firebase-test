<!DOCTYPE html>
  <html>
    <head>
      <meta charset="UTF-8">
      <title>Electron-Firebase Quickstart Cloud Framework</title>
      <!--
        load Bootstrap components - NOTE we have to swap the module definition to make jQuery happy
      -->
      <script> 
        if (typeof module === 'object') {window.module = module; module = undefined;} 
      </script>
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
      <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
      <script>
        if (window.module) module = window.module; 
      </script>
      <!--
        electron-firebase components
      -->
	    <link rel="stylesheet" href="/css/json-viewer.css">
      <script src="/scripts/json-viewer.js"></script>
      <script src="/scripts/webutils.js"></script>
      <script src="/scripts/weblocal.js"></script>
      <script>
      // functions for interacting with main app
      // note that ipc is defined in weblocal.js

      // send the signout signal back to Main
      function signout() {
          ipc.send( 'user-signout', Date.now().toString() ) 
      }

      function modalOkay() {
        console.log( "It Is OKAY!" )
      }

      // render the user's profile information
      ipc.on( 'user-profile', ( event, profile ) => {
          // json viewer at https://www.cssscript.com/minimal-json-data-formatter-jsonviewer/
          var jsonViewer = new JSONViewer()
          document.getElementById("json_user").appendChild(jsonViewer.getContainer())
          jsonViewer.showJSON( profile, -1, 1 )
          userProfile = profile
          ipc.send( 'profile-response', userProfile.displayName )
      })
      var userProfile = null
    </script>

    </head>
    <body>

      <div class="alert alert-secondary" role="alert">
        <h2>Electron-Firebase Quickstart Cloud Framework</h2>
        <button type="button" class="btn btn-warning btn-sm" onclick="signout()">Sign Out</button>
      </div>

      <div class="container border border-info rounded text-info m-3 p-3 vw-100">
        <h3>
          Profile Information
        </h3>
        <button type="button" class="btn btn-info" data-title="profile" data-toggle="modal" data-target="#ModalDialog">
          User Identity
        </button>
        <button type="button" class="btn btn-info" data-title="provider" data-toggle="modal" data-target="#ModalDialog">
          ID Provider
        </button>
        <button type="button" class="btn btn-info" data-title="appcontext" data-toggle="modal" data-target="#ModalDialog">
          App Context
        </button>

                <!--
                <table class="table">
                </table>
                -->
        <!-- ModalDialog with table content -->
        <div class="modal fade" id="ModalDialog" tabindex="-1" role="dialog" aria-labelledby="ModalDialogLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">---</h5>
              </div>
              <div class="modal-body">
              </div>
              <div class="modal-footer">
                <button type="button" id="ModalDialogAccept" class="btn btn-secondary" data-dismiss="modal">OK</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="window-content">
          <div class="form-group" id="json_user">
            <h4>Account Information:</h4>
          </div>
      </div>

      <script>

        var modalTitles = {
          profile: "User Profile Info",
          provider: "Identity Provider Info"
        }

        function isImagePath(url) 
        {
          if ( !url ) return false
          return( url.match( /\.(jpeg|jpg|gif|png)$/, 'i' ) != null )
        }

        function isURL( whatever )
        {
          if ( !whatever ) return false
          return( whatever.match( /^(http|https):\/\//, 'i' ) != null )
        }
        
        function makeImageElement( url )
        {
          var image = $('<img>')
          image.attr( 'src', url )
          image.attr( 'height', 128 )
          return image
        }

        function makeJsonElement( arg )
        {
          var pretext = $('<pre>')
          pretext.text( JSON.stringify( arg, null, 4 ) )
          return pretext
        }

        function createTableRow( table, ...args )
        {
          var row = $('<tr>')
          table.append(row) 
          for (let arg of args) {
            var cell = $('<td>')
            row.append(cell)
            if ( $.isPlainObject(arg) ) {
              cell.append( makeJsonElement(arg) )
            }
            else if ( isURL(arg) ) {
              cell.append( makeImageElement(arg) )
            }
            else {
              cell.text(arg)
            }
          }
        }

        function setModalContent( table, recipient )
        {
          ipc.once( 'InfoRequest', ( event, response ) => {
            Object.entries(response).forEach( ([key,value]) => {
              createTableRow( table, key, value )
            })
          })
          ipc.send( 'InfoRequest', recipient )
        }

        $('#ModalDialog').on('show.bs.modal', function (event) {
          var recipient = $(event.relatedTarget).data('title') // Extract info from data-* attributes
          var modal = $(this)
          modal.find('.modal-title').text( modalTitles[recipient] )
          modal.find('.table').remove()
          var table = $('<table class="table">') 
          modal.find('.modal-body').append(table)
          setModalContent( table, recipient )
        })

        $('#ModalDialogAccept').on('click', function (event) {
          var button = $(event.relatedTarget) // Button that triggered the modal
console.log( "CLICK ModalDialogAccept" )
        })
  
      </script>
  
    </body>

  </html>