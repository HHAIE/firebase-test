<!DOCTYPE html>
  <html>
    <head>
      <meta charset="UTF-8">
      <title>Electron-Firebase Quickstart Cloud Framework</title>
      <!--
        Load Bootstrap components - NOTE we have to swap the module definition to make 
        jQuery happy (which Bootstrap needs)
      -->
      <script> 
        if (typeof module === 'object') {window.module = module; module = undefined;} 
      </script>
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
      <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
      <script>
        if (window.module) module = window.module; 
      </script>
      <!--
        electron-firebase components
      -->
      <script src="/scripts/webutils.js"></script>
      <script src="/scripts/weblocal.js"></script>
      <style>
        a.nav-link:hover:not(.active) {
            color: #F00F00 !important;
            cursor: pointer;
        }
      </style>
      </head>

    <body>
      <div class="alert alert-secondary" role="alert">
        <h2>Electron-Firebase Quickstart Cloud Framework</h2>
        <button type="button" class="btn btn-warning btn-sm" onclick="signout()">Sign Out</button>
      </div>
      <div id="main-window-content" class="d-none">
        <div class="container border border-info rounded text-info m-3 p-3 vw-100">
          <h3>Global User and App Information</h3>
          <button is="info-button" data-set="user" data-ask="profile">User Profile</button>
          <button is="info-button" data-set="user" data-ask="provider">Identity Provider</button>
          <button is="info-button" data-set="user" data-ask="context">Application Context</button>
        </div>
        <div class="container border border-info rounded text-info m-3 p-3 vw-100">
          <h3>Cloud Firestore Objects in /aboutme</h3>
          <button is="info-button" data-set="docs" data-ask="account">/account</button>
          <button is="info-button" data-set="docs" data-ask="profile">/profile</button>
          <button is="info-button" data-set="docs" data-ask="provider">/provider</button>
          <button is="info-button" data-set="docs" data-ask="session">/session</button>
        </div>  
        <div class="container border border-info rounded text-info m-3 p-3 vw-100">
          <h3>Cloud Firestore Objects</h3>
          <div class="row">
            <div class="col-3">
              <div id="nav-folder-links" class="nav flex-column nav-pills" role="tablist" aria-orientation="vertical">
              </div>
            </div>
            <div class="col-9">
              <div id="nav-folder-files" class="tab-content" id="v-pills-tabContent">
              </div>
            </div>
          </div>
        </div>  
      </div>
      <!--
        The main-window-loading is shown when the app starts, until is gets the signal
        from the main app to start, which should happen once the user is authenticated.
      -->
      <div id="main-window-loading" class="jumbotron jumbotron-fluid">
        <div class="d-flex justify-content-center align-items-center">
          <div class="spinner-border spinner-border-lg text-secondary m-3" role="status">
            <span class="sr-only">Loading...</span>
          </div>
          <h3 class="text-secondary">Starting the application...</h3>
        </div>
      </div>
      <!--
        The following is the modal dialog, which is normally not seen until one of the
        info-button objects is clicked.
      -->
      <div class="modal fade text-info" id="ModalDialog" tabindex="-1" role="dialog" aria-labelledby="ModalDialogLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
          <div class="modal-content">
            <div class="modal-header align-items-center justify-content-start text-light bg-secondary">
              <div class="spinner-border m-2">
                  <span class="sr-only">Loading...</span>
              </div>
              <h5 class="modal-title">---</h5>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
              <button type="button" id="ModalDialogAccept" class="btn btn-secondary" data-dismiss="modal">OK</button>
            </div>
          </div>
        </div>
      </div>

      <script>

      // functions for interacting with main app, note that ipc is defined in weblocal.js

      function signout() 
      {
          // send the signout signal back to Main
          ipc.send( 'user-signout', Date.now().toString() ) 
      }

      // custom elements
      class InfoButton extends HTMLButtonElement {
        constructor() {
          super()
          this.setAttribute('class', 'btn btn-info')
          this.setAttribute('type', 'button')
          this.setAttribute('data-toggle', 'modal')
          this.setAttribute('data-target', '#ModalDialog')
        }
      }
      customElements.define('info-button', InfoButton, {extends: 'button'});

      // functions for formatting data returned from info-buttons requests
      function isImagePath(url) 
      {
        if ( typeof url !== 'string' ) return false
        return null != url.match( /\.(jpeg|jpg|gif|png)$/, 'i' )
      }

      function isURL( whatever )
      {
        if ( typeof whatever !== 'string' ) return false
        return null != whatever.match( /^(http|https):\/\//, 'i' )
      }
      
      function makeImageElement( url )
      {
        var image = $('<img>')
        image.attr( 'src', url )
        image.attr( 'height', 128 )
        return image
      }

      function makeJsonElement( arg )
      {
        var pretext = $('<pre>')
        pretext.text( JSON.stringify( arg, null, 4 ) )
        return pretext
      }

      function makeBasicElement( arg )
      {
        return String( arg )
      }

      function createTableRow( table, ...args )
      {
        var row = $('<tr>')
        table.append(row) 
        for (let arg of args) {
          var cell = $('<td>')
          row.append(cell)
          // make a formatting decision based on the content of this arg
          if ( $.isPlainObject(arg) )  cell.append( makeJsonElement(arg) )
          else if ( isURL(arg) )       cell.append( makeImageElement(arg) )
          else                         cell.text( makeBasicElement( arg ) )
        }
      }

      async function setModalContent( table, request, parameter )
      {
        // send the info-request back to the main app, and 
        // stuff each response into a table row
        const response = await askMain( 'info-request', request, parameter )
        await Object.entries(response).forEach( ([key,value]) => {
          createTableRow( table, key, value )
        })
        return response
      }

      function createNavLink( navColumn, link )
      {
        var anchor = $('<a>')
        anchor.addClass( "nav-link" )
        anchor.attr( "data-toggle", "pill" )
        anchor.attr( "role", "tab" )
        anchor.attr( "aria-controls", "v-pills-profile" )
        anchor.attr( 'href', '#folder-list-anchor')
        anchor.attr( "data-link", link )
        anchor.text( link )
        navColumn.append( anchor )
      }

      async function setFolderList( domain = "file" )
      {
        // ask the main app for the folder list
        // put each folder into a nav column of links
        var navColumn = $("#nav-folder-links")
        const response = await askMain( "info-request", "folder-list", domain )
        await response.forEach( (element) => {
          createNavLink( navColumn, element )
        })
        return response
      }

      $('#nav-folder-links').on('click', function (event) {
        event.preventDefault()
        const anchor = $(event.target)
        const panel = $(this)

        alert( anchor.data('link') )
        askMain( "info-request", "file-list", 'file', anchor.data('link') )
        .then( (response) => {
          response.forEach( (element) => {
            console.log( element )
          })
        })
      })

      $('#ModalDialog').on('show.bs.modal', function (event) 
      {
        // The modal dialog is about to open, but it's generic.
        // So we need to set its title, and build a table with the right content.
        event.preventDefault()
        const button = $(event.relatedTarget)
        const modal = $(this)
        const modalSpinner = modal.find('.modal-header').find('.spinner-border')
        modalSpinner.removeClass("invisible")
        modal.find('.modal-title').text( button.text() )
        modal.find('.table').remove()
        var table = $('<table class="table">') 
        modal.find('.modal-body').append(table)
        setModalContent( table, button.data('set'), button.data('ask') )
        .then( () => {
          modalSpinner.addClass("invisible")
        })
      })

      $('#ModalDialogAccept').on('click', function (event) 
      {
        var button = $(event.relatedTarget) // Button that triggered the modal
        // do whatever you want after the user accepts OK
      })

      ipc.on( 'user-ready', () => 
      {
          // hide the opening spinner and show the contents
          $("#main-window-loading").addClass("d-none")
          $("#main-window-content").removeClass("d-none")

          // populate the folder list
          setFolderList('file')
      })

      </script>
  
    </body>

  </html>