<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Electron-Firebase Login</title>
    <script src="/node_modules/firebase/firebase.js"></script>
    <script src="/node_modules/firebaseui/dist/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="/node_modules/firebaseui/dist/firebaseui.css" /> 
    <script src="/scripts/webutils.js"></script>
    <script type="text/javascript">

    /* For definition of firebaseUI, see: https://github.com/firebase/firebaseui-web
     * 
     * This page does not use ipc to contact the main process because it will call 
     * external authentication pages, so for security this page should run without
     * nodeIntegration enabled. Therefore communication between this Renderer
     * process and the Main process happens through API calls over HTTPS.
     */

    const getConfigUrl      = "/api/appconfig"
    const postTokenUrl      = "/api/logintoken"
    const loginCompleteUrl  = "/pages/logincomplete.html"

    function getIdentityConfig( provider )
    {
        switch ( provider ) {
        case 'google.com':
            return {
                provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                scopes: [ 
                    'profile', 
                    'email', 
                    'openid', 
                    'https://www.googleapis.com/auth/devstorage.full_control' 
                ],
                customParameters: { prompt: 'select_account' }
            }
        case 'facebook.com':
            return {
                provider: firebase.auth.FacebookAuthProvider.PROVIDER_ID,
                scopes: [ 
                    'public_profile', 
                    'email' 
                ],
                customParameters: { auth_type: 'reauthenticate' }
            }
        case 'twitter.com':
            return { provider: firebase.auth.TwitterAuthProvider.PROVIDER_ID }
        case 'github.com':
            return { provider: firebase.auth.GithubAuthProvider.PROVIDER_ID }
        case 'password':
            return { provider: firebase.auth.EmailAuthProvider.PROVIDER_ID }
        case 'phone':
            return { provider: firebase.auth.PhoneAuthProvider.PROVIDER_ID }
        }
        return null
    }

    function getUserProfile( authUser )
    {
        return {
            account: authUser.user.toJSON(),
            profile: authUser.additionalUserInfo.profile,
            providerId: authUser.additionalUserInfo.providerId,
            credential: authUser.credential,
            accessToken: authUser.credential.accessToken,
            idToken: authUser.credential.idToken,
            refreshToken: authUser.user.refreshToken
        }
    }

    function postAuthResult( authResult )
    {
        // authResult is https://firebase.google.com/docs/reference/js/firebase.auth#.UserCredential
        // the user's credentials and profile get sent back to Main process via API
        api( 'POST', postTokenUrl, getUserProfile( authResult ) )
        .then( (status) => {
            // redirect to the login complete page which should close this window
            window.location.assign( loginCompleteUrl );
        })
        .catch( (error) => {
            alert( "ERROR in sign-in process, please restart this application: ", stringifyJSON(error) )
            window.close()
        })
    }

    function firebaseAuthUIStart( fbConfig ) {

        // initializeApp must be called before any other Firebase APIs
        firebase.initializeApp( fbConfig )

        // Do not persist authentication in the browser. We will pass credentials after the first login  
        // which will allow the Main process to keep a session for the user, until they sign out.
        firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)

        var uiConfig = {
            callbacks: {
                signInSuccessWithAuthResult: ( authResult, redirectUrl ) => {
                    postAuthResult( authResult )
                    // return false to prevent redirection
                    return false;
                },
                signInFailure: ( error, credential ) => {
                    alert( "Sign in failure: " + error + ". Please restart the app" )
                    window.close()
                },
                uiShown: () => {
                    // The widget is rendered. Hide the loader.
                    document.getElementById('loader').style.display = 'none';
                }
            },
            signInOptions: [
                // fill this in dynamically based on configuration
            ],
            // see: https://github.com/firebase/firebaseui-web#credential-helper
            credentialHelper: firebaseui.auth.CredentialHelper.ACCOUNT_CHOOSER_COM,           
            // tosUrl and privacyPolicyUrl accept either url string or a callback function.
            tosUrl: fbConfig.tosUrl,
            privacyPolicyUrl: fbConfig.privacyUrl
        };

        // set up the configuration for each identity provider that was specified in uiConfig
        fbConfig.providers.forEach( ( provider ) => {
            uiConfig.signInOptions.push( getIdentityConfig( provider ) )
        })

        // Initialize the FirebaseUI Widget
        var ui = new firebaseui.auth.AuthUI( firebase.auth() );
        ui.start('#firebaseui-auth-container', uiConfig);
    }

    // when the document is loaded, call Main process to get the app config parameters
    // and then we can start firebaseui
    document.onreadystatechange = function () {
        if ( document.readyState !== 'complete' ) return
        // ask the Main process to get the configuration parameters for firebase authentication
        api( 'GET', getConfigUrl, null )
        .then( (response) => {
            firebaseAuthUIStart( response )
        })
        .catch( (error) => {
            alert( "ERROR getting app configuration, please restart application" )
        })
    }

    </script> 
  </head>
  <body>
    <!-- The surrounding HTML is left untouched by FirebaseUI.
         Your app may use that space for branding, controls and other customizations.-->
    <h2>Electron-Firebase Template App</h2>
    <div id="firebaseui-auth-container"></div>
    <div id="loader">Loading Firebase Login...</div>
  </body>
</html>

