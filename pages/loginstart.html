<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Electron-Firebase Login</title>
    <script src="/node_modules/firebase/firebase.js"></script>
    <script src="/node_modules/firebaseui/dist/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="/node_modules/firebaseui/dist/firebaseui.css" /> 
    <script src="/scripts/webutils.js"></script>
    <script type="text/javascript">

    /* For definition of firebaseUI, see: https://github.com/firebase/firebaseui-web
     * 
     * This page does not use ipc to contact the main process because it will call 
     * external authentication pages, so for security this page should run without
     * nodeIntegration enabled. Therefore communication between this Renderer
     * process and the Main process happens through API calls over HTTPS.
     */

    const getConfigUrl      = "/api/appconfig"
    const postTokenUrl      = "/api/logintoken"
    const loginCompleteUrl  = "/pages/logincomplete.html"
    const fbDatabaseName    = "firebaseLocalStorageDb"
    const fbStorageName     = "firebaseLocalStorage"
    const fbStoredUserKey   = "firebase:authUser"

    var   rememberThisUser  = true
    var   persistentUser    = null

    function openObjectStore( dataStoreName, dataObjectName, openMode )
    {
        var dbReq, fbdb, transaction
        return new Promise( (resolve, reject) => 
        {
            dbReq = indexedDB.open( dataStoreName, 1 )
            dbReq.onerror = (error) => {
                reject( "openObjectStore ERROR opening database, ", error )
            }
            dbReq.onsuccess = (event) => {
                fbdb = event.target.result
                transaction = fbdb.transaction( dataObjectName, openMode || "readonly" )
                transaction.onerror = (error) => {
                    reject( "openObjectStore transaction ERROR, ", error )
                }
                resolve( transaction.objectStore( dataObjectName ) )
            }
        })
    }

    function findKeyInStore( dbStore, dbKeyName )
    {
        var keyReq, keyList, foundKey
        return new Promise( (resolve, reject) => 
        {
            keyReq = dbStore.getAllKeys()
            keyReq.onerror = (error) => {
                reject( "findKeyInStore ERROR getting all keys, ", error )
            }
            keyReq.onsuccess = (event) => {
                keyList = event.target.result
                foundKey = keyList.find( (element, index) => {
                    return ( element.indexOf( dbKeyName ) == 0 )
                })
                if ( !foundKey ) {
                    return reject( "findKeyInStore: NO KEY" )
                }
                resolve( foundKey )
            }
        })
    }

    function getObjectFromStore( dbStore, dbKeyName )
    {
        var keyValueReq
        return new Promise( (resolve, reject) => 
        {
            findKeyInStore( dbStore, dbKeyName )
            .then( (foundKey) => {
                keyValueReq = dbStore.get( foundKey )
                keyValueReq.onerror = (error) => {
                    reject( "getObjectFromStore ERROR getting value, ", error )
                }
                keyValueReq.onsuccess = (event) => {
                    resolve( event.target.result )
                }
            })
            .catch( (error) => {
                reject( "getObjectFromStore ERROR finding key, ", error )
            })
        })
    }

    function deleteObjectFromStore( dbStore, dbKeyName )
    {
        var keyValueReq
        return new Promise( (resolve, reject) => 
        {
            findKeyInStore( dbStore, dbKeyName )
            .then( (foundKey) => {
                keyValueReq = dbStore.delete( foundKey )
                keyValueReq.onerror = (error) => {
                    reject( "deleteObjectFromStore ERROR deleting key, ", error )
                }
                keyValueReq.onsuccess = (event) => {
                    resolve( "user deleted" )
                }
            })
            .catch( (error) => {
                reject( "deleteObjectFromStore ERROR finding key, ", error )
            })
        })
    }

    function getIdentityConfig( provider )
    {
        switch ( provider ) {
        case 'google.com':
            return {
                provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                scopes: [ 
                    'profile', 
                    'email', 
                    'openid', 
                    'https://www.googleapis.com/auth/devstorage.full_control' 
                ],
                customParameters: { prompt: 'select_account' }
            }
        case 'facebook.com':
            return {
                provider: firebase.auth.FacebookAuthProvider.PROVIDER_ID,
                scopes: [ 
                    'public_profile', 
                    'email' 
                ],
                customParameters: { auth_type: 'reauthenticate' }
            }
        case 'twitter.com':
            return { provider: firebase.auth.TwitterAuthProvider.PROVIDER_ID }
        case 'github.com':
            return { provider: firebase.auth.GithubAuthProvider.PROVIDER_ID }
        case 'password':
            return { provider: firebase.auth.EmailAuthProvider.PROVIDER_ID }
        case 'phone':
            return { provider: firebase.auth.PhoneAuthProvider.PROVIDER_ID }
        }
        return null
    }

    async function getUserProfile( authUser )
    {
        var currentUser = null
        if ( !authUser ) return Promise.reject( "NO USER" )
        await authUser.getIdToken()
        .then( async (idToken) => {
            var thisUser = authUser.toJSON() 
            // this is an object, not JSON?!?! You can't make this stuff up.

            const provider = authUser.providerData[0]

            currentUser = {
                uid: thisUser.uid,
                displayName: thisUser.displayName,
                providerId: provider.providerId,
                providerUid: provider.uid,
                apiKey: thisUser.apiKey,
                refreshToken: thisUser.stsTokenManager.refreshToken,
                accessToken: thisUser.stsTokenManager.accessToken,
                expirationTime: thisUser.stsTokenManager.expirationTime,
                lastLoginAt: thisUser.lastLoginAt,
                createdAt: thisUser.createdAt,
                idToken: idToken,
                provider: provider,
                user: thisUser
            }
        })
        .catch( (error) => {
            alert( "Authentication error getting identity token: ", error )
        })
        return currentUser
/*
console.log( "getUserProfile: ", authUser.toJSON() )

        return {
            account: authUser.user.toJSON(),
            profile: authUser.additionalUserInfo.profile,
            providerId: authUser.additionalUserInfo.providerId,
            credential: authUser.credential,
            accessToken: authUser.credential.accessToken,
            idToken: authUser.credential.idToken,
            refreshToken: authUser.user.refreshToken
        }
*/
    }

    function getProviderCredential( userIdentity )
    {
        // returns: https://firebase.google.com/docs/reference/node/firebase.auth.OAuthCredential
        if ( !userIdentity ) return null

console.log( "convertToOAuth, userIdentity: ", userIdentity )

        switch( userIdentity.providerData[0].providerId  ) {
        case 'google.com':
            return firebase.auth.GoogleAuthProvider.credential( userIdentity.idToken ) 
        case 'facebook.com':
            return firebase.auth().FacebookAuthProvider.credential( userIdentity.accessToken )
        case 'twitter.com':
            return firebase.auth().TwitterAuthProvider.credential( userIdentity.accessToken, userIdentity.secret )
        case 'github.com':
            return firebase.auth().GithubAuthProvider.credential( userIdentity.accessToken )
        case 'password':
            return firebase.auth().EmailAuthProvider.credentialWithLink( userIdentity.email, userIdentity.emailLink )
        case 'phone':
            return firebase.auth().PhoneAuthProvider.credential( userIdentity.verificationId, userIdentity.verificationCode )
        }
        return null
    }

/**
 * Permission iam.serviceAccounts.signBlob is required to perform this operation
 * on service account projects/-/serviceAccounts/{your-service-account-id}.
 * The easiest way to resolve this is to grant the "Service Account Token Creator" 
 * IAM role to the service account in question, usually 
 * {project-name}@appspot.gserviceaccount.com:
*/

    function postAuthResult( authResult )
    {
        console.log( "postAuthResult: ", authResult )

        const thisUser = firebase.auth().currentUser

        console.log( "thisUser: ", thisUser.displayName )
        console.log( "persistentUser: ", persistentUser )

        thisUser.getIdToken()
        .then( (newToken) => {
            console.log( "idTokenResult: ", newToken)
            const appUpdate = {
                user: thisUser.toJSON(),
                operationType: authResult.operationType || null,
                additionalUserInfo: authResult.additionalUserInfo,
                refreshToken: authResult.refreshToken || authResult.user.refreshToken,
                persistent: persistentUser,
                idToken: newToken
            }
            console.log( "appUpdate (1): ", appUpdate )

            if ( authResult.credential ) {
                appUpdate.credentialIdentity = firebase.auth.GoogleAuthProvider.credential( authResult.credential.idToken ).toJSON()
                appUpdate.credentialAccess = firebase.auth.GoogleAuthProvider.credential( authResult.credential.accessToken ).toJSON()
            }

            console.log( "appUpdate (2): ", appUpdate )
            return api( 'POST', postTokenUrl, appUpdate )
        })
        .then( (status) => {
            // redirect to the login complete page which should close this window
            
            
////            window.location.assign( loginCompleteUrl );


// console.log( "postAuthResult, window.close: ", status )
////            window.close()
        })
        .catch( (error) => {
            alert( "ERROR in sign-in process, please restart this application: ", stringifyJSON(error) )
            window.close()
        })

/****
        const thisUser = firebase.auth().currentUser

        console.log( "postAuthResult authResult: ", authResult )
        console.log( "postAuthResult thisUser: ", thisUser )

        thisUser.getIdToken()
        .then( (token) => {

            console.log( "postAuthResult token: ", token )
            console.log( "authResult.credential: ", authResult.credential )

            const authCredential = firebase.auth.GoogleAuthProvider.credential( token ) 

            authCredential.id_token = "" + authCredential.idToken
            console.log( "authCredential: ", authCredential )

            firebase.auth().signInWithCredential( authResult.credential )
            .then( (userCredential) => {
                console.log( "userCredential: ", userCredential )
            })
            .catch( (error) => {
                console.log( "signInWithCredential ERROR: ", error )
            })

        })
****/
/*****
        //        getUserProfile( authResult ) 
//        .then( (user) => {

console.log( "postAuthResult, authResult: ", authResult )

            const thisUser = firebase.auth().currentUser.toJSON()
//            thisUser.credential = getProviderCredential( thisUser )

//console.log( "thisUser.credential: ", thisUser.credential )

//            firebase.auth().signInWithCredential( thisUser.credential )
//            .then( (response) => {
//                console.log( "signInWithCredential: ", response )
//                return api( 'POST', postTokenUrl, thisUser )
//            })
              return api( 'POST', postTokenUrl, thisUser )
//        })
        .then( (status) => {
            // redirect to the login complete page which should close this window
//            window.location.assign( loginCompleteUrl );
console.log( "postAuthResult, window.close: ", status )
////            window.close()
        })
        .catch( (error) => {
//            alert( "ERROR in sign-in process, please restart this application: ", stringifyJSON(error) )
//            window.close()
        })


*****/


/*
        // authResult is https://firebase.google.com/docs/reference/js/firebase.auth#.UserCredential
        // the user's credentials and profile get sent back to Main process via API
        api( 'POST', postTokenUrl, getUserProfile( authResult ) )
        .then( (status) => {
            // redirect to the login complete page which should close this window
////////            window.location.assign( loginCompleteUrl );
        })
        .catch( (error) => {
            alert( "ERROR in sign-in process, please restart this application: ", stringifyJSON(error) )
            window.close()
        })
*/
    }

    function firebaseAuthUIStart( fbConfig ) 
    {
        var uiConfig = {
            callbacks: {
                signInSuccessWithAuthResult: ( authResult, redirectUrl ) => {
                    // send the authentication event and result back to the main app
////                    var authCredential = convertToOAuth( authResult.credential )
                    postAuthResult( authResult )
                    // return false to prevent redirection
                    return false
                },
                signInFailure: ( error, credential ) => {
                    alert( "Sign in failure: " + error + ". Please restart the app" )
                    window.close()
                },
                uiShown: () => {
                    // The widget is rendered. Hide the loader.
                    document.getElementById('loader').style.display = 'none';
                }
            },
            signInOptions: [
                // fill this in dynamically based on configuration
            ],
            // see: https://github.com/firebase/firebaseui-web#credential-helper
            credentialHelper: firebaseui.auth.CredentialHelper.ACCOUNT_CHOOSER_COM,           
            // tosUrl and privacyPolicyUrl accept either url string or a callback function.
            tosUrl: fbConfig.tosUrl,
            privacyPolicyUrl: fbConfig.privacyUrl
        }

        // Initialize the FirebaseUI Widget
        // set up the configuration for each identity provider that was specified in uiConfig
        fbConfig.providers.forEach( ( provider ) => {
            uiConfig.signInOptions.push( getIdentityConfig( provider ) )
        })
        var ui = new firebaseui.auth.AuthUI( firebase.auth() )
        ui.start('#firebaseui-auth-container', uiConfig)
    }

    async function checkForPersistentUser()
    {
        return new Promise( (resolve, reject) => 
        {
            openObjectStore( fbDatabaseName, fbStorageName )
            .then( (dbStore) => {
                const persistentUser = getObjectFromStore( dbStore, fbStoredUserKey )

console.log( "persistentUser: ", persistentUser )

                return persistentUser
            })
            .then( (userObject) => {
                resolve( userObject )
            })
            .catch( (error) => {
                reject( "checkForPersistentUser ERROR, ", error )
            })
        })
    }

    function setUserPersistence( allowPersistence )
    {
        var persistence = firebase.auth.Auth.Persistence.SESSION
        if ( allowPersistence )
        {
            persistence = firebase.auth.Auth.Persistence.LOCAL
        }
        return firebase.auth().setPersistence( persistence )
    }

    function authStateChangedEvent( user )
    {
        console.log( "authStateChangedEvent: ", user ? user.displayName : "NO USER" )
        
        if (user) {
            // User is signed in.
            postAuthResult( user )
        }
    }

    // when the document is loaded, call Main process to get the app config parameters
    // and then we can start firebaseui
    document.onreadystatechange = function () {
        if ( document.readyState !== 'complete' ) return

console.log( "READY!" )

        // ask the Main process to get the configuration parameters for firebase authentication
        api( 'GET', getConfigUrl, null )
        .then( (response) => {
            // allow functions to access the firebase configuration set
            const fbConfig = response

console.log( "fbConfig = ", fbConfig )

            // initializeApp must be called before any other Firebase APIs
            firebase.initializeApp( fbConfig )

console.log( "fb initialized, remember: ", rememberThisUser )

            // whether or not the user is forced to log in every time
            setUserPersistence( rememberThisUser )
            .then( () => {
                console.log( "user persistence set " )
                // we must make a decision: if there is a persistent user then do not start the login workflow
                return checkForPersistentUser()
            })
            .then( (foundUser) => 
            {

console.log( "foundUser: ", foundUser )

                if ( !foundUser ) {
                    throw( "NO USER" )
                }
                // we found a user defined in the IndexedDB object store, so wait for the login
                persistentUser = foundUser.value

console.log( "sts: ", foundUser.value )

                firebase.auth().onAuthStateChanged( authStateChangedEvent )
            })
            .catch( (error) => {
                // no persisted user or some error, so start the login UI workflow from firebaseUI
                firebaseAuthUIStart( fbConfig )
            })
        })
        .catch( (error) => {
            alert( "ERROR getting app configuration, please restart application" )
        })
    }

    </script> 
  </head>
  <body>
    <!-- The surrounding HTML is left untouched by FirebaseUI.
         Your app may use that space for branding, controls and other customizations.-->
    <h2>Electron-Firebase Template App</h2>
    <div id="firebaseui-auth-container"></div>
    <div id="loader">Loading Firebase Login...</div>
  </body>
</html>

