<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Electron-Firebase Login</title>
    <script src="/node_modules/firebase/firebase.js"></script>
    <script src="/node_modules/firebaseui/dist/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="/node_modules/firebaseui/dist/firebaseui.css" /> 
    <script src="/scripts/webutils.js"></script>
    <script type="text/javascript">

    /* For definition of firebaseUI, see: https://github.com/firebase/firebaseui-web
     * 
     * This page does not use ipc to contact the main process because it will call 
     * external authentication pages, so for security this page should run without
     * nodeIntegration enabled. Therefore communication between this Renderer
     * process and the Main process happens through API calls over HTTPS.
     */

    // These specify the local storage location for persistent user credentials,
    // which we can use to determine if there is a persistent credential that is
    // used for auto-login. 
    const fbDatabaseName    = "firebaseLocalStorageDb"
    const fbStorageName     = "firebaseLocalStorage"
    const fbStoredUserKey   = "firebase:authUser"

    const queryParams = new URLSearchParams( location.search )

    const idpConfig = {
        'google.com': {
            provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
            scopes: [ 
                'profile', 
                'email', 
                'openid', 
                'https://www.googleapis.com/auth/devstorage.full_control' 
            ],
            customParameters: { prompt: 'select_account' }
        },
        'facebook.com': {
            provider: firebase.auth.FacebookAuthProvider.PROVIDER_ID,
            scopes: [ 
                'public_profile', 
                'email' 
            ],
            customParameters: { auth_type: 'reauthenticate' }
        },
        'twitter.com': { 
            provider: firebase.auth.TwitterAuthProvider.PROVIDER_ID 
        },
        'github.com': { 
            provider: firebase.auth.GithubAuthProvider.PROVIDER_ID 
        },
        'password': { 
            provider: firebase.auth.EmailAuthProvider.PROVIDER_ID 
        },
        'phone': { 
            provider: firebase.auth.PhoneAuthProvider.PROVIDER_ID 
        }
    }

    function getQueryParam( paramName )
    {
        return queryParams.get( paramName )
    }

    function getTrueQueryParam( paramName )
    {
        const value = queryParams.get( paramName ) || ""
        return ( value === true ) || ( value.toLowerCase() === 'true' )
    }

    function openObjectStore( dataStoreName, dataObjectName, openMode )
    {
        var dbReq, fbdb, transaction
        return new Promise( (resolve, reject) => 
        {
            dbReq = indexedDB.open( dataStoreName, 1 )
            dbReq.onerror = (error) => {
                reject( "openObjectStore ERROR opening database, ", error )
            }
            dbReq.onsuccess = (event) => {
                fbdb = event.target.result
                transaction = fbdb.transaction( dataObjectName, openMode || "readonly" )
                transaction.onerror = (error) => {
                    reject( "openObjectStore transaction ERROR, ", error )
                }
                resolve( transaction.objectStore( dataObjectName ) )
            }
        })
    }

    function findKeyInStore( dbStore, dbKeyName )
    {
        var keyReq, keyList, foundKey
        return new Promise( (resolve, reject) => 
        {
            keyReq = dbStore.getAllKeys()
            keyReq.onerror = (error) => {
                reject( "findKeyInStore ERROR getting all keys, ", error )
            }
            keyReq.onsuccess = (event) => {
                keyList = event.target.result
                foundKey = keyList.find( (element, index) => {
                    return ( element.indexOf( dbKeyName ) == 0 )
                })
                if ( !foundKey ) {
                    return reject( "findKeyInStore: NO KEY" )
                }
                resolve( foundKey )
            }
        })
    }

    function getObjectFromStore( dbStore, dbKeyName )
    {
        var keyValueReq
        return new Promise( (resolve, reject) => 
        {
            findKeyInStore( dbStore, dbKeyName )
            .then( (foundKey) => {
                keyValueReq = dbStore.get( foundKey )
                keyValueReq.onerror = (error) => {
                    reject( "getObjectFromStore ERROR getting value, ", error )
                }
                keyValueReq.onsuccess = (event) => {
                    resolve( event.target.result )
                }
            })
            .catch( (error) => {
                reject( "getObjectFromStore ERROR finding key, ", error )
            })
        })
    }

    function deleteObjectFromStore( dbStore, dbKeyName )
    {
        var keyValueReq
        return new Promise( (resolve, reject) => 
        {
            findKeyInStore( dbStore, dbKeyName )
            .then( (foundKey) => {
                keyValueReq = dbStore.delete( foundKey )
                keyValueReq.onerror = (error) => {
                    reject( "deleteObjectFromStore ERROR deleting key, ", error )
                }
                keyValueReq.onsuccess = (event) => {
                    resolve( "user deleted" )
                }
            })
            .catch( (error) => {
                reject( "deleteObjectFromStore ERROR finding key, ", error )
            })
        })
    }

    function postAuthResult( authResult )
    {
        // authResult is https://firebase.google.com/docs/reference/js/firebase.auth#.UserCredential
        // the user's credentials get sent back to Main process via API
        const appUpdate = {
            user: firebase.auth().currentUser.toJSON(),
            operationType: authResult.operationType || null,
            additionalUserInfo: authResult.additionalUserInfo,
            refreshToken: authResult.refreshToken || authResult.user.refreshToken,
            credential: authResult.credential || null
        }
        return api( 'POST', getQueryParam( "logintoken" ), appUpdate )
        .then( (status) => {
            // redirect to the login complete page which should close this window
            window.location.assign( getQueryParam( "loginRedirect" ) )
        })
        .catch( (error) => {
            alert( "ERROR in sign-in process, please restart this application: ", stringifyJSON(error) )
            window.close()
        })
    }

    async function showLoginWindow()
    {
        var responseCode = null

        await api( 'GET', getQueryParam( "loginready" ), null )
        .then( (response) => {
            responseCode = response.status
        })
        .catch( (error ) => {
            console.error( "showLoginWindow ERROR: ", error )
        })
        return responseCode
    }

    function firebaseAuthUIStart( fbConfig ) 
    {
        var uiConfig = {
            callbacks: {
                signInSuccessWithAuthResult: ( authResult, redirectUrl ) => {
                    // send the authentication event and result back to the main app
                    postAuthResult( authResult )
                    // return false to prevent redirection
                    return false
                },
                signInFailure: ( error, credential ) => {
                    alert( "Sign in failure: " + error + ". Please restart the app" )
                    window.close()
                },
                uiShown: () => {
                    // The widget is rendered. Hide the loader.
                    document.getElementById('loader').style.display = 'none';
                }
            },
            signInOptions: [
                // fill this in dynamically based on configuration
            ],
            // see: https://github.com/firebase/firebaseui-web#credential-helper
            credentialHelper: firebaseui.auth.CredentialHelper.ACCOUNT_CHOOSER_COM,           
            // tosUrl and privacyPolicyUrl accept either url string or a callback function.
            tosUrl: fbConfig.tosUrl,
            privacyPolicyUrl: fbConfig.privacyUrl
        }

        // Initialize the FirebaseUI Widget
        // set up the configuration for each identity provider that was specified in uiConfig
        fbConfig.providers.forEach( ( provider ) => {
            uiConfig.signInOptions.push( idpConfig[ provider ] )
        })
        var ui = new firebaseui.auth.AuthUI( firebase.auth() )
        ui.start('#firebaseui-auth-container', uiConfig)
    }

    async function checkForPersistentUser()
    {
        return new Promise( (resolve, reject) => 
        {
            openObjectStore( fbDatabaseName, fbStorageName )
            .then( (dbStore) => {
                return getObjectFromStore( dbStore, fbStoredUserKey )
            })
            .then( (userObject) => {
                resolve( userObject )
            })
            .catch( (error) => {
                reject( "checkForPersistentUser ERROR, ", error )
            })
        })
    }

    function setUserPersistence( allowPersistence )
    {
        var persistence = firebase.auth.Auth.Persistence.SESSION
        if ( allowPersistence )
        {
            persistence = firebase.auth.Auth.Persistence.LOCAL
        }
        return firebase.auth().setPersistence( persistence )
    }
    
    function checkForSignout()
    {
        return new Promise( (resolve, reject) => 
        {
            // normal case is no signout, just leave
            if ( !getTrueQueryParam( "signoutuser" ) ) return resolve( true )

            // clear the user persistence, then sign out
            firebase.auth().setPersistence( firebase.auth.Auth.Persistence.NONE )
            .then( () => {
                return firebase.auth().signOut()
            })
            .then( () => {
                resolve( true )
            })
            .catch( (error) => {
                alert( "Error in signout process: ", error )
                reject( error )
            })
        })
    }

    // when the document is loaded, call Main process to get the app config parameters
    // and then we can start firebaseui
    document.onreadystatechange = function () 
    {
        if ( document.readyState !== 'complete' ) return

        // ask the Main process to get the configuration parameters for firebase authentication
        api( 'GET', getQueryParam( "firebaseconfig" ), null )
        .then( (fbConfig) => {

            // initializeApp must be called before any other Firebase APIs
            firebase.initializeApp( fbConfig )

            // a signout request may be passed in the browser querystring
            checkForSignout()
            .then( () => {
                // whether or not the user is forced to log in every time
                return setUserPersistence( getTrueQueryParam( "persistentUser" ) )
            })
            .then( () => {
                // we must make a decision: if there is a persistent user then do not start the login workflow
                return checkForPersistentUser()
            })
            .then( (foundUser) => 
            {
                if ( !foundUser ) {
                    throw( "NO USER" )
                }
                // we found a user defined in the IndexedDB object store, so wait for the login
                firebase.auth().onAuthStateChanged( postAuthResult )
            })
            .catch( (error) => {
                // no persisted user or some error, so start the login UI workflow from firebaseUI
                showLoginWindow()
                .then( (response) => {
                    firebaseAuthUIStart( fbConfig )
                })
                .catch( (error) => {
                    // how to notify the user if we fail to show the window??
                    console.error( "showLoginWindow ERROR: ", error )
                })
            })
        })
        .catch( (error) => {
            alert( "ERROR getting app configuration, please restart application" )
        })
    }

    </script> 
  </head>
  <body>
    <!-- The surrounding HTML is left untouched by FirebaseUI.
         Your app may use that space for branding, controls and other customizations.-->
    <h2>Electron-Firebase Quickstart Cloud Framework</h2>
    <div id="firebaseui-auth-container"></div>
    <div id="loader">Loading Firebase Login...</div>
  </body>
</html>

